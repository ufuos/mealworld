{% extends 'base.html' %}
{% block title %}Checkout{% endblock %}
{% block content %}

<div class="card shadow-custom border-0 col-lg-7 mx-auto mb-3">
  <h3 class="py-2 font-weight-bold text-grey text-center">
    Delivery information:
  </h3>

  <script src="https://js.stripe.com/v3/"></script>

  <form method="post" id="payment-form">
    {% csrf_token %}

    <div class="row">
      <div class="col-md-6">
        <div class="input-field">
          <label class="text-muted">First name</label>
          {{ order_form.first_name }}
        </div>
      </div>

      <div class="col-md-6">
        <div class="input-field">
          <label class="text-muted">Last name</label>
          {{ order_form.last_name }}
        </div>
      </div>

      <div class="col-md-6">
        <div class="input-field">
          <label class="text-muted">Email</label>
          {{ order_form.email }}
        </div>
      </div>

      <div class="col-md-6">
        <div class="input-field">
          <label class="text-muted">Phone number</label>
          {{ order_form.telephone }}
        </div>
      </div>
    </div>

    <hr class="mt-0">

    <div class="row">
      <div class="col-md-6">
        <div class="input-field">
          <label class="text-muted">Address</label>
          {{ order_form.address }}
        </div>
      </div>

      <div class="col-md-6">
        <div class="input-field">
          <label class="text-muted">Postal code</label>
          {{ order_form.postal_code }}
        </div>
      </div>

      <div class="col-md-6">
        <div class="input-field mb-0">
          <label class="text-muted">City</label>
          {{ order_form.city }}
        </div>
      </div>

      <div class="col-md-6">
        <div class="input-field mb-0">
          <label class="text-muted">Country</label>
          {{ order_form.country }}
        </div>
      </div>
    </div>

</div>

{% if not request.user.is_authenticated %}
<div class="mt-2 text-center">
  Already registered?
  <a href="{% url 'login' %}" class="text-decoration-none">Log in</a>
</div>
{% endif %}

<hr>

<h4 class="py-2 font-weight-bold text-grey">Transport:</h4>
<div class="row">
  <div class="col-md-12">

    <div class="radiobtn">
      <input type="radio" id="id_transport_0" name="transport" value="Courier delivery" amount="{{ transport_cost }}"
        checked onclick="setTotalCost()" />
      <label for="id_transport_0">
        Courier delivery
        <span class="text-danger float-right pr-3 font-weight-bold">
          ${{ transport_cost }}
        </span>
      </label>
    </div>

    <div class="radiobtn">
      <input type="radio" id="id_transport_1" name="transport" value="Recipient pickup" amount="free"
        onclick="setTotalCost()" />
      <label for="id_transport_1">
        Recipient pickup
        <span class="text-success float-right pr-3 font-weight-bold">free</span>
      </label>
    </div>

  </div>
</div>

<h4 class="py-2 font-weight-bold text-grey">Payment:</h4>
<div class="form-row">
  <div id="card-element"></div>
  <div id="card-errors" role="alert"></div>
</div>

<hr class="mb-4">

<div class="input-field">
  <label class="text-muted">Note</label>
  {{ order_form.note }}
</div>

<h4 class="py-2 font-weight-bold text-grey">
  Price total:
  <span id="order-total" class="text-danger float-right"></span>
</h4>

<div class="row justify-content-end mt-3">
  <div class="col-lg-8 px-0">
    <div class="btn-group d-flex">
      <a href="{% url 'listings:meal_list' %}" class="btn btn-warning shadow-custom col">
        Back to shop
      </a>
      <button type="submit" class="btn btn-danger shadow-custom col">
        Create order
      </button>
    </div>
  </div>
</div>

</form>

</div>

<script>
  var stripe = Stripe('pk_test_51HY6jqApSgCDuEQrpaGvLSOdyhkyutUCgmtLUg84B9x2suaFobSYA8TERgSvFkJxJbdJKMxBrdhUZbjBqUnePmWj00LLLV4AAq');
  var elements = stripe.elements();

  var style = {
    base: {
      color: '#32325d',
      fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
      fontSmoothing: 'antialiased',
      fontSize: '16px',
      '::placeholder': { color: '#aab7c4' }
    },
    invalid: {
      color: '#fa755a',
      iconColor: '#fa755a'
    }
  };

  var card = elements.create('card', { style: style });
  card.mount('#card-element');

  card.on('change', function (event) {
    var displayError = document.getElementById('card-errors');
    displayError.textContent = event.error ? event.error.message : '';
  });

  var form = document.getElementById('payment-form');

  form.addEventListener('submit', function (event) {
    event.preventDefault();
    stripe.createToken(card).then(function (result) {
      if (result.error) {
        document.getElementById('card-errors').textContent = result.error.message;
      } else {
        stripeTokenHandler(result.token);
      }
    });
  });

  function stripeTokenHandler(token) {
    var form = document.getElementById('payment-form');
    var hiddenInput = document.createElement('input');
    hiddenInput.setAttribute('type', 'hidden');
    hiddenInput.setAttribute('name', 'stripeToken');
    hiddenInput.setAttribute('value', token.id);
    form.appendChild(hiddenInput);
    form.submit();
  }
</script>

<!-- Thank You Card -->
<div class="card shadow-custom border-0 col-lg-7 mx-auto mb-3">
  <div class="py-3">
    <h3 class="text-center">
      Thank you for your order. Order number is <strong>{{ order.id }}</strong>
    </h3>
    <div class="text-center">
      We value your order and we hope your taste buds will enjoy our meals.
      In case of any questions, do not hesitate to contact us!
    </div>
  </div>
</div>

{% endblock content %}